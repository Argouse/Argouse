(()=>{"use strict";const t=window.epimetheus,e=window.reportId||114514,n=new class{constructor(){this.available=10,this.taskList=[],setTimeout((()=>{this.run()}))}addTask(t){this.taskList.push(t)}run(){var t=this.taskList.length;if(t){var e=Math.min(t,this.available);for(let t=0;t<e;t++)this.available--,this.taskList.shift()().then((t=>{})).catch((t=>{})).finally((()=>{this.available++,this.run()}))}}};async function o(n){let o=t+n?.url;var r=n?.method,a=n?.header,i=Object.assign({reportid:e},n?.data),s=n?.params;const d=[];if(s){for(const t in s)d.push(t+"="+s[t]);-1===o.search(/\?/)?o+="?"+d.join("&"):o+="&"+d.join("&")}return n={"Content-Type":"application/json",...a},fetch(o,{method:r,body:JSON.stringify(i),headers:new Headers(n),mode:"cors",credentials:"omit"}).then((t=>t.json())).catch((t=>t))}async function r(t){n.addTask(o({url:"/metrics/report",method:"POST",data:t}))}async function a(t){n.addTask(o({url:"/replay/reportDOMevent",method:"POST",data:t}))}function i(t,e){r({type:"pageStay",data:{pageUrl:t,time:e}})}function s(t){return[(new Date).getTime()-t,t=(new Date).getTime()]}function d(t){const e=history[t];return function(){var n=e.apply(this,arguments);const o=new Event(t);return o.arguments=arguments,window.dispatchEvent(o),n}}let c=new Array,p={jsError:[],loadingError:[],whiteScreen:[],InterfaceError:[]};function u(t){p.jsError.push(t)}function l(t){p.InterfaceError.push(t)}let f="interfaceError",h=0,m=0;const g=new Array;function y(t){let e=0;return["html","body","div"].forEach((n=>{t.tagName.toLowerCase()===n&&(e=1)})),e}function w(t,e){const n=document.createElement("div");n.style.cssText="position:fixed; color: red",n.style.left=t+"px",n.style.top=e+"px",n.innerHTML="<p>+</p>",document.body.append(n)}const v={type:"performanceInfo",data:{FP:0,FCP:0,DNS:0,DOMready:0,TCPduration:0,requestTime:0}};function L(t,e){return null!=e.dom&&(t+=e.dom),0!=e.children.length&&e.children.forEach((e=>{"text"===e.type?t+=e.text.trim():"node"===e.type&&(t+=L("",e))})),null!=e.endTag?t+=e.endTag:t}function S(t,e,n){let o={};var r,a;return o.index=e,1===t.nodeType?(o.dom=function(t){var e=t.tagName.toLowerCase();const n=t.outerHTML.trim();return t=new RegExp("^<"+e+".*?>","g"),n.match(t)?n.match(t)[0]:`<${e}>`}(t),o.endTag=(e=t,r=o.dom,e=e.tagName.toLowerCase(),a=new RegExp("</"+e+">","g"),r.match(a)?"":`</${e}>`),o.style=t.style.cssText,o.type="node",o.tagName=t.tagName.toLowerCase(),o.text=""):(o.dom="",o.endTag="",o.style="",o.tagName="",o.type="text",o.text=t.wholeText||`\x3c!--  ${t.nodeValue}  --\x3e`),n&&(o.operation=n),o.id=t.id||"",o.class=t.className||"",o.children=[],o}function E(t,e,n=0,o){var r;let a=0;for(const i of t.childNodes)"SCRIPT"!==i.tagName&&(1===i.nodeType?(r=i.firstChild,e.push(S(i,n,o)),r&&E(i,e[a].children,0,o)):e.push(S(i,n,o)),n++,a++)}function T(t){let e=[],n=t;for(;"BODY"!==n.tagName;){var o=function(t){if("BODY"===t.tagName)return 0;let e=0;for(const n of t.parentElement.children){if(n===t)return e;"SCRIPT"!==n.tagName&&e++}}(n);e.push(o),n=n.parentElement}return e.reverse(),e}function D(t,e=document.body){let n=e;for(const e of t)n=n.children[e];return n}!function(t={}){var e;if((t=Object.assign({sendPV:!0,sendApi:!0,sendError:!0,sendPerf:!0,sendDom:!0,openLog:!1,reportURL:"/metrics/report"},t)).sendPV){const t=new Array;let e=null;window.onload=function(n){t.push(location.href),c.push(location.href),e=(new Date).getTime()},history.pushState=d("pushState"),history.replaceState=d("replaceState"),window.onpopstate=function(n){var o=null;[o,e]=s(e),i(t.pop(),o),t.push(location.href),c.push(location.href)},window.addEventListener("replaceState",(function(n){var o=null;[o,e]=s(e),i(t.pop(),o),t.push(location.href),c.push(location.href)})),window.addEventListener("pushState",(function(n){var o=null;[o,e]=s(e),i(t.pop(),o),t.push(location.href),c.push(location.href)}))}t.sendApi&&(window.onbeforeunload=t=>{r({type:"successRate",data:{rate:m/h}}),r({type:"allTrace",data:{trace:g}})}),t.sendError&&function(t={reportURL:"",openLog:!1}){var e;e=t,Object.keys(p).forEach((t=>{const n=p[t].push;p[t].push=function(t){r(t),e.openLog,n.apply(this,arguments)}})),function(t){var e;window.addEventListener("error",(e=t,function(t){t.error?u({type:"jsError",data:{errorMessage:t.message,pageUrl:t.filename,errorPosition:t.lineno+","+t.colno,errorStack:t.error.stack,timeStamp:Date.now()}}):(t={type:"loadingError",data:{pageUrl:t.target.baseURI,loadingDOM:t.target.outerHTML,loadingSrc:t.target.attributes.src.value,timeStamp:Date.now()}},p.loadingError.push(t)),e.openLog}),!0)}(t),function(t){setTimeout((()=>{{var e=t;let c=0;var n=document.documentElement.clientWidth,o=document.documentElement.clientHeight;for(let t=1;t<9;t++){var r=n/8*t-n/16,a=o/8*t-o/16,i=document.elementFromPoint(n/2,a),s=document.elementFromPoint(r,o/2);c=(c+=y(i))+y(s),e.openLog&&w(n/2,a),e.openLog&&w(r,o/2)}if(15<=c){var d={type:"blankScreenError",data:{pageUrl:window.location.href,whiteScreenDOMNums:c,timeStamp:Date.now()}};p.whiteScreen.push(d)}e.openLog}}),4e3)}(t),function(t){var e;window.addEventListener("unhandledrejection",(e=t,function(t){u(t={type:"unhandledError",data:{pageUrl:window.location.href,errorStack:void 0===t.reason.stack?t.reason:t.reason.stack,errorMessage:void 0===t.reason.message?t.reason:t.reason.message,timeStamp:Date.now()}}),e.openLog}))}(t),function(t){{var e=t;const n=XMLHttpRequest.prototype.open,o=(XMLHttpRequest.prototype.open=function(t,o,r){var a=e.reportURL;return""!==a&&-1!==o.indexOf(a)||(this.logData={method:t,url:o,isAsync:r}),n.apply(this,arguments)},XMLHttpRequest.prototype.send);XMLHttpRequest.prototype.send=function(t){if(this.logData){const t=Date.now();var n=n=>n=>{var o=Date.now()-t,r=this.status,a=this.statusText,i=Math.floor(r/100);g.push({status:r,trace:this.logData.url}),h++,200==r&&m++,2!==i&&(i={type:f,data:{duration:o,pageUrl:window.location.href,interfaceURL:this.logData.url,status:r+" "+a,response:this.response?JSON.stringify(this.response):"",timeStamp:Date.now()}},e.openLog,l(i))};this.addEventListener("error",n()),this.addEventListener("load",n()),this.addEventListener("abort",n())}return o.apply(this,arguments)}}{var n=t;const e=fetch;Object.defineProperty(window,"fetch",{configurable:!0,enumerable:!0,get:()=>(t,o)=>{const r=Date.now();return e(t,{...o}).then((e=>{var a=Date.now()-r,i=Math.floor(e.status/100);return 0!==t.indexOf(window.epimetheus)&&(g.push({status:e.status,trace:t}),h++,200==e.status&&m++),2!==i&&-1===t.indexOf(n.reportURL)&&l({type:f,data:{duration:a,pageUrl:window.location.href,interfaceURL:e.url,status:e.status+" "+e.statusText,response:e.response?JSON.stringify(e.response):"",timeStamp:Date.now()}}),o}),(e=>{var o;-1===t.indexOf(n.reportURL)&&(o=Date.now()-r,l({type:f,data:{duration:o,pageUrl:window.location.href,interfaceURL:t,status:e.message+" "+e.stack,response:"",timeStamp:Date.now()}}))}))}})}}(t)}(t),t.sendPerf&&(e=t,window.addEventListener("load",(function(){var t=performance.getEntriesByType("navigation")[0],n=performance.getEntriesByType("paint")[1];v.data.DOMready=t.domContentLoadedEventEnd-t.fetchStart,v.data.DNS=t.domainLookupEnd-t.domainLookupStart,v.data.TCPduration=t.connectEnd-t.connectStart,v.data.requestTime=t.responseEnd-t.responseStart,v.data.FP=t.domInteractive-t.fetchStart,v.data.FCP=n.startTime,r(v),e.openLog}))),t.sendDom&&function(){var t;location.href.includes("replay")?(t=windows.epimetheus+"/replay/getDOMevent?reportid="+windows.reportId,fetch(t,{headers:{"content-type":"application/json"},method:"get"}).then((t=>{t.json().then((t=>{!function(t){const e=document.querySelector("#monitor"),n=document.querySelector("#currentplay");document.querySelector("#message").innerHTML="this page from "+t[0].pageUrl;var o=t[0].timeStamp;let r=[];for(const e of t){var a=e.timeStamp-o;r.push(a)}let i=100/t.length;for(const o in r)setTimeout((()=>{"DOMupdate"===t[o].type||"originInfo"===t[o].type?e.innerHTML=t[o].domInfo:"buttonClick"===t[o].type?(r=D(t[o].domInfo,e),(s=r).style.backgroundColor="#307c6a",s.style.color="#f1cfc1",setTimeout((()=>{s.style.backgroundColor="",s.style.color=""}),500)):"textUpdate"===t[o].type&&(r=D(t[o].domInfo,e),a=r,d=t[o].text,a.style.backgroundColor="#307c6a",a.style.color="#f1cfc1",a.value=d,setTimeout((()=>{a.style.backgroundColor="",a.style.color=""}),500));var r,a,s,d=parseInt(o)+1;n.style.width=i*d+"vw"}),r[o])}(t.data)}))}))):(window.addEventListener("load",(()=>{var t=S(document.body,0,"originInfo");a((E(document.body,t.children),t={data:{domInfo:L("",t),type:"originInfo",timeStamp:Date.now(),pageUrl:window.location.href}}))})),function(){let t=document.querySelector("body");const e=Date.now(),n=new Array;t.addEventListener("change",(function(t){var o,r=t.target;for(const t of["INPUT","TEXTAREA"])if(t===r.tagName)return n.push({time:Date.now-e,dom:t}),void a(o={data:{domInfo:T(o=r),text:o.value,type:"textUpdate",timeStamp:Date.now(),pageUrl:window.location.href}})})),t.addEventListener("click",(function(t){var o=t.target;for(const t of["BUTTON"])if(t===o.tagName)return n.push({time:Date.now-e,dom:t}),void a({data:{domInfo:T(o),type:"buttonClick",timeStamp:Date.now(),pageUrl:window.location.href}})}))}(),function(){var t=document.querySelector("body");new MutationObserver((function(t){for(const n of t)"childList"==n.type?(e=void 0,e=S(document.body,0,"update"),E(document.body,e.children),a(e={data:{domInfo:L("",e),type:"DOMupdate",timeStamp:Date.now(),pageUrl:window.location.href}})):n.type;var e})).observe(t,{attributes:!0,childList:!0,subtree:!0})}())}()}(function(t){let e={};if(!(t.indexOf("?")<0)){var n=(t=t.split("?")[1]).split("&");for(let t=0;t<n.length;t++){var o=n[t].split("=");e[o[0]]=JSON.parse(o[1])}}return e}(document.getElementById("Argouse").getAttribute("src")))})();